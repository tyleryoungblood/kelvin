<!DOCTYPE html>
<html>
  <head>
    <title>Richland Library Room Schedule Viewer</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div id="stage1"></div>
    <div id="datePicker" class="hidden">
      <div class="wrapper">
        <button id="prevDay">&larr; Prev</button>
        <span id="dateSelected"></span>
        <button id="nextDay">Next &rarr;</button>
      </div>
    </div>
    <div id="stage2"></div>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"
      integrity="sha256-4iQZ6BVL4qNKlQ27TExEhBN1HFPvAvAMbFavKKosSWQ="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/moment-range/4.0.2/moment-range.js"
      integrity="sha256-bB6c2ZfNzG6Tv8MSu/pqUl0y91h86M/T+1w0WrCZhGw="
      crossorigin="anonymous"
    ></script>

    <script>
      // init moment-range
      window['moment-range'].extendMoment(moment);

      // momentjs humanize time: 1 hour = >= 55 minutes
      moment.relativeTimeThreshold('m', 55);

      //const rcplBase = "https://larvis.com/rcpl";
      //const rcplBase = "https://www.richlandlibrary.com";
      //const rcplBase = 'http://localvm.richland-site.com';

      // use current hostname so this will work across local, dev, and prod
      const rcplBase = window.location.protocol + '//' + window.location.hostname;

      const fetchJson = async url => {
        const response = await fetch(url);
        return await response.json();
      };

      const fetchData = async () => {
        const url =
          rcplBase +
          '/jsonapi/node/room?filter%5Bstatus%5D%5Bvalue%5D=1&filter%5Bfield_staff_use_only%5D%5Bvalue%5D=false&filter%5Blocations%5D%5Bgroup%5D%5Bconjunction%5D=AND&filter%5BwithLocation%5D%5Bcondition%5D%5Bpath%5D=field_location.id&filter%5BwithLocation%5D%5Bcondition%5D%5Boperator%5D=%3C%3E&filter%5BwithLocation%5D%5Bcondition%5D%5BmemberOf%5D=locations&filter%5BonlyBranchLocation%5D%5Bcondition%5D%5Bpath%5D=field_location.field_branch_location&filter%5BonlyBranchLocation%5D%5Bcondition%5D%5Bvalue%5D=1&filter%5BonlyBranchLocation%5D%5Bcondition%5D%5BmemberOf%5D=locations&fields%5Bnode--room%5D=uuid%2Cstatus%2Ctitle%2Croom_thumbnail%2Cfield_capacity_max%2Cfield_capacity_min%2Cfield_reservable_online%2Cfield_room_fees%2Cfield_room_standard_equipment%2Cfield_reservation_phone_number%2Cfield_text_content%2Cfield_text_intro%2Cfield_text_teaser%2Ctype%2Cuid%2Cimage_primary%2Cfield_location%2Cfield_room_type&include=image_primary%2Cimage_primary.field_media_image%2Cfield_location&sort=title';
        console.log('Fetching rooms');
        return await fetchJson(url);
      };

      const fetchCachedData = async () => {
        const now = moment();
        let data = localStorage.roomData && JSON.parse(localStorage.roomData);

        const invalid =
          !data || !data.expires || !now.isBefore(moment(data.expires).add(1, 'days'));
        if (invalid) {
          data = await fetchData();
          data.expires = moment().format();
          localStorage.roomData = JSON.stringify(data);
        }
        return data;
      };

      const getLocations = data => {
        return data['included']
          .filter(obj => obj.type === 'node--location')
          .map(obj => ({
            id: obj.id,
            title: obj.attributes.title,
            hours: obj.attributes.field_location_hours
          }));
      };

      const getLocationRooms = (data, location) => {
        return data['data']
          .filter(
            obj =>
              obj.type === 'node--room' && obj.relationships.field_location.data.id === location.id
          )
          .map(obj => ({
            id: obj.id,
            title: obj.attributes.title,
            location: location
          }));
      };

      const saveSelectedRooms = rooms => {
        localStorage.selectedRooms = JSON.stringify(rooms.map(room => room.id));
      };

      const loadSelectedRooms = () => {
        if (localStorage.selectedRooms) {
          const roomIds = JSON.parse(localStorage.selectedRooms);
          for (const id of roomIds) {
            const el = document.querySelector(`input[data-room="${id}"]`);
            if (el) {
              el.checked = true;
            }
          }
        }
      };

      // begin here
      fetchCachedData().then(data => {
        const locations = getLocations(data).map(loc => ({
          ...loc,
          rooms: getLocationRooms(data, loc)
        }));

        window.locationData = locations;

        let html = ['<p>', 'Select the rooms to show and click show at the bottom', '</p>'].join(
          '\n'
        );
        for (const loc of locations) {
          let rstr = loc.rooms.reduce(
            (acc, room) =>
              acc +
              `
                        <li class="room-item">
                          <input
                            type="checkbox"
                            class="room-input"
                            data-room="${room.id}"
                            />
                          ${room.title}
                        </li>`,
            ''
          );
          html += `<div class="location" data-location="${loc.id}">
                        <h3>
                          <input 
                            type="checkbox"
                            class="check-uncheck-all" />
                          ${loc.title}</h3>
                        <ul class="room-list">
                          ${rstr}
                        </ul>
                    </div>`;
        }
        html += '\n<button onClick="showLocation()">Show</button>';
        $('#stage1').html(html);
        loadSelectedRooms();
      });

      const findRoom = roomId => {
        for (const loc of locationData) {
          for (const room of loc.rooms) {
            if (room.id === roomId) {
              return room;
            }
          }
        }
      };

      const getRoomsAvailability = async (rooms, date = null) => {
        // show the selected date between prev/next buttons
        date = date.clone() || moment();
        const dateSelected = document.getElementById('dateSelected');
        dateSelected.innerHTML = date.format('dddd, MMMM Do');

        const url = rcplBase + '/api/rooms/availability';
        const dateFormat = 'YYYY-MM-DDTHH:mm:ss'; // without the Z
        const payload = {
          rooms: rooms.map(room => room.id),
          start: date
            .startOf('day')
            .utc()
            .format(dateFormat),
          end: date
            .clone()
            .endOf('day')
            .utc()
            .format(dateFormat)
        };

        const response = await fetch(url, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        return await response.json();
      };

      const showChart = async (rooms, date = null) => {
        date = date || moment();
        console.log('Showing chart for ', date.format());

        const open_time = moment.min(
          rooms.map(room => {
            const hours = room.location.hours[date.day()].starthours;
            const time = date
              .clone()
              .hour(Math.floor(hours / 100))
              .minute(hours % 100);
            return time;
          })
        );
        const close_time = moment.max(
          rooms.map(room => {
            const hours = room.location.hours[date.day()].endhours;
            const time = date
              .clone()
              .hour(Math.floor(hours / 100))
              .minute(hours % 100);
            return time;
          })
        );

        const cols = close_time.diff(open_time, 'minutes') / 15;
        const rows = rooms.length + 1;

        const stage2 = $('<div/>', {
          id: 'stage2'
        });

        // render open hours
        stage2.css('grid-template-columns', `auto repeat(${cols}, 1fr)`);
        const openDiv = $('<div/>', {
          class: 'open-header',
          text: 'Open'
        });

        const openStr = open_time.format('MM/DD hh:mm A');
        const closeStr = close_time.format('MM/DD hh:mm A');
        const openHoursDiv = $('<div/>', {
          class: 'open-hours',
          text: `Opening hours: ${openStr} - ${closeStr}`,
          style: 'grid-column: 2 / -1; grid-row: 1;'
        });
        stage2.append([openDiv, openHoursDiv]);

        const drawHours = (rowStart = 2) => {
          for (let i = 0; i < cols / 4; i++) {
            const time = open_time.clone().add(i, 'hours');
            const div = $('<div/>', {
              text: `${time.format('h a')}`,
              class: 'grid-hours'
            });
            div.css('grid-column', `${i * 4 + 2} / span 4`);
            div.css('grid-row', `${rowStart}`);
            stage2.append(div);
          }
        };

        drawHours(2);

        const open_range = moment.range(open_time, close_time);
        const events = await getRoomsAvailability(rooms, date);

        let cRow = 2; // 1st=header, 2nd=hours, hence the offset

        // Sort rooms at Main by room number
        // Otherwise Meeting Rooms 200-214 show, and then Study Rooms 206-209 show.
        // Instead it should show Meeting Room 200 ... Meeing Room 205, Study Room 206 ... Study Room 209, Meeting Room 213, Meeting Room 214
        rooms = rooms.sort((a, b) => {
          // check to see if this is a room located at main
          if (
            a.location.title == 'Richland Library Main' &&
            b.location.title == 'Richland Library Main'
          ) {
            // sort rooms at main so that the meeting and study rooms are in numeric order.

            // first, strip all non-numeric values from a and b strings
            a = a.title.replace(/\D/g, '');
            b = b.title.replace(/\D/g, '');

            // check to see if it's a single digit room, and if so, pad the digits with two leading zeros
            // if you don't do this, Family Career Studio desk 1 and 2 display, then meeting and study rooms,
            // and then Family Career Studio Desk 3 and 4 display
            if (a.length > 0 && a.length < 3) {
              a = '00' + a;
            }

            if (b.length > 0 && b.length < 3) {
              b = '00' + b;
            }

            // check to make sure both a and b are rooms with numbers - prevents sorting BCRC above Auditorium
            if (a >= 1 && b >= 1) {
              // finally perform the sort
              return a > b ? 1 : -1;
            }
          }
        });

        for (const room of rooms) {
          cRow++;
          const roomNameDiv = $('<div/>', {
            text: room.title,
            style: `grid-row: ${cRow};`,
            class: 'room-name'
          });
          stage2.append(roomNameDiv);

          if (events[room.id] && events[room.id].is_closed) {
            const row = $('<div/>', {
              text: `${events[room.id].closed_message}`,
              class: 'room-reserved room-closed'
            });
            $(row).css('grid-row', `${cRow}`);
            $(row).css('grid-column', '2 / -1');
            stage2.append(row);
            continue;
          }

          const dates = events[room.id] && events[room.id].dates;
          if (!dates) {
            continue;
          }

          for (const evtId in dates) {
            let { start, end } = dates[evtId];
            start = moment.utc(start).local();
            end = moment.utc(end).local();

            // skip whatever isn't in the current day schedule
            const range = moment.range(start, end);
            if (!range.overlaps(open_range)) {
              continue;
            }

            // truncate to open hours
            start = open_range.contains(start) ? start : open_range.start;
            end = open_range.contains(end) ? end : open_range.end;

            // render
            const colstart = 2 + Math.ceil(start.diff(open_time, 'minutes') / 15);
            const colspan = Math.ceil(end.diff(start, 'minutes') / 15);
            const day = start.local().format('MMM DD');
            const startTime = start.local().format('hh:mm a');
            const endTime = end.local().format('hh:mm a');
            const hrs = moment.duration(end.diff(start)).humanize(false);
            const row = $('<div/>', {
              text: '',
              class: 'reserved-event',
              title: `Reserved on ${day} from ${startTime} to ${endTime} (${hrs})`
            });
            $(row).css('grid-row', `${cRow}`);
            $(row).css('grid-column', `${colstart} / span ${colspan}`);
            stage2.append(row);
          }
        }

        // draw border
        for (let i = 0; i < cols / 4; i++) {
          const div = $('<div/>', {
            class: 'highlight'
          });
          div.css('grid-column', `${i * 4 + 2} / span 4`);
          div.css('grid-row', `2 / ${cRow + 3}`);
          stage2.append(div);
        }

        drawHours(cRow + 1);

        // replace stage2, avoid the flash
        $('#stage2').replaceWith(stage2);
      };

      function showLocation() {
        console.log('Showing locations');
        const rooms = $('.room-input:checked')
          .map((idx, el) => findRoom(el.dataset.room))
          .get();
        saveSelectedRooms(rooms);
        console.log('rooms', rooms);

        $('#stage1').hide();
        $('#datePicker')
          .show()
          .removeClass('hidden');
        $('#stage2').html('Loading...');

        let selectedDate = moment().local();

        const changeDate = date => {
          console.log(selectedDate);
          selectedDate = moment(date);
          console.log('Changed date', date.format());
          showChart(rooms, selectedDate.clone());
        };

        // register event handlers
        $('#nextDay').click(() => changeDate(selectedDate.clone().add(1, 'days')));
        $('#prevDay').click(() => changeDate(selectedDate.clone().subtract(1, 'days')));

        console.log('selected date = ', selectedDate.format());

        setInterval(() => {
          showChart(rooms, selectedDate.clone()).then(() => {
            console.log(`Chart updated: ${moment().format('h:mm a')}`);
            createRedLine();
          });
        }, 1000 * 60); // update every minute;

        showChart(rooms, selectedDate.clone()).then(() => {
          console.log(`Chart displayed ${moment().format('h:mm a')}`);
          createRedLine();
        });
      }
    </script>

    <script src="js/check-uncheck-all.js"></script>
    <script src="js/red-line.js"></script>
  </body>
</html>
