<!DOCTYPE html>
<html>
  <head>
    <title>Richland Library Room Schedule Viewer</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div id="stage1"></div>
    <div id="datePicker" class="hidden">
      <div class="wrapper">
        <button id="prevDay">&larr; Prev</button>
        <span id="dateSelected"></span>
        <button id="nextDay">Next &rarr;</button>
      </div>
    </div>
    <div id="stage2"></div>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"
      integrity="sha256-4iQZ6BVL4qNKlQ27TExEhBN1HFPvAvAMbFavKKosSWQ="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/moment-range/4.0.2/moment-range.js"
      integrity="sha256-bB6c2ZfNzG6Tv8MSu/pqUl0y91h86M/T+1w0WrCZhGw="
      crossorigin="anonymous"
    ></script>

    <script>
      window["moment-range"].extendMoment(moment);
      //var date = date || moment().add(6, "days");
      var date = date || moment();
      var rooms = rooms || null;

      // momentjs humanize time: 1 hour = >= 55 minutes
      moment.relativeTimeThreshold("m", 55);

      const rcplBase = "https://larvis.com/rcpl";
      //const rcplBase = "https://www.richlandlibrary.com";

      const fetchJson = async url => {
        const response = await fetch(url);
        return await response.json();
      };

      const fetchData = async () => {
        const url =
          rcplBase +
          "/jsonapi/node/room?filter%5Bstatus%5D%5Bvalue%5D=1&filter%5Bfield_staff_use_only%5D%5Bvalue%5D=false&filter%5Blocations%5D%5Bgroup%5D%5Bconjunction%5D=AND&filter%5BwithLocation%5D%5Bcondition%5D%5Bpath%5D=field_location.id&filter%5BwithLocation%5D%5Bcondition%5D%5Boperator%5D=%3C%3E&filter%5BwithLocation%5D%5Bcondition%5D%5BmemberOf%5D=locations&filter%5BonlyBranchLocation%5D%5Bcondition%5D%5Bpath%5D=field_location.field_branch_location&filter%5BonlyBranchLocation%5D%5Bcondition%5D%5Bvalue%5D=1&filter%5BonlyBranchLocation%5D%5Bcondition%5D%5BmemberOf%5D=locations&fields%5Bnode--room%5D=uuid%2Cstatus%2Ctitle%2Croom_thumbnail%2Cfield_capacity_max%2Cfield_capacity_min%2Cfield_reservable_online%2Cfield_room_fees%2Cfield_room_standard_equipment%2Cfield_reservation_phone_number%2Cfield_text_content%2Cfield_text_intro%2Cfield_text_teaser%2Ctype%2Cuid%2Cimage_primary%2Cfield_location%2Cfield_room_type&include=image_primary%2Cimage_primary.field_media_image%2Cfield_location&sort=title";
        console.log("Fetching rooms");
        return await fetchJson(url);
      };

      const fetchCachedData = async () => {
        const now = moment();
        let data = localStorage.roomData && JSON.parse(localStorage.roomData);

        const invalid =
          !data ||
          !data.expires ||
          !now.isBefore(moment(data.expires).add(1, "days"));
        if (invalid) {
          data = await fetchData();
          data.expires = moment().format();
          localStorage.roomData = JSON.stringify(data);
        }
        return data;
      };

      const getLocations = data => {
        return data["included"]
          .filter(obj => obj.type === "node--location")
          .map(obj => ({
            id: obj.id,
            title: obj.attributes.title,
            hours: obj.attributes.field_location_hours
          }));
      };

      const getLocationRooms = (data, location) => {
        return data["data"]
          .filter(
            obj =>
              obj.type === "node--room" &&
              obj.relationships.field_location.data.id === location.id
          )
          .map(obj => ({
            id: obj.id,
            title: obj.attributes.title,
            location: location
          }));
      };

      const saveSelectedRooms = rooms => {
        localStorage.selectedRooms = JSON.stringify(rooms.map(room => room.id));
      };

      const loadSelectedRooms = () => {
        if (localStorage.selectedRooms) {
          const roomIds = JSON.parse(localStorage.selectedRooms);
          for (const id of roomIds) {
            const el = document.querySelector(`input[data-room="${id}"]`);
            if (el) {
              el.checked = true;
            }
          }
        }
      };

      // begin here
      fetchCachedData().then(data => {
        const locations = getLocations(data).map(loc => ({
          ...loc,
          rooms: getLocationRooms(data, loc)
        }));

        window.locationData = locations;

        let html = [
          "<p>",
          "Select the rooms to show and click show at the bottom",
          "</p>"
        ].join("\n");
        for (const loc of locations) {
          let rstr = loc.rooms.reduce(
            (acc, room) =>
              acc +
              `
                        <li class="room-item">
                          <input
                            type="checkbox"
                            class="room-input"
                            data-room="${room.id}"
                            />
                          ${room.title}
                        </li>`,
            ""
          );
          html += `<div class="location" data-location="${loc.id}">
                        <h3>${loc.title}</h3>
                        <ul class="room-list">
                          ${rstr}
                        </ul>
                        </div>`;
        }
        html += '\n<button onClick="showLocation()">Show</button>';
        document.getElementById("stage1").innerHTML = html;
        loadSelectedRooms();
      });

      const findRoom = roomId => {
        for (const loc of locationData) {
          for (const room of loc.rooms) {
            if (room.id === roomId) {
              return room;
            }
          }
        }
      };

      const getRoomsAvailability = async (rooms, date = null) => {
        // show the selected date between prev/next buttons
        const dateSelected = document.getElementById("dateSelected");
        dateSelected.innerHTML = date.format("dddd, MMMM Do");

        const url = rcplBase + "/api/rooms/availability";
        const dateFormat = "YYYY-MM-DDTHH:mm:ss"; // without the Z
        const payload = {
          rooms: rooms.map(room => room.id),
          start: date
            .startOf("day")
            .utc()
            .format(dateFormat),
          end: date
            .clone()
            .endOf("day")
            .utc()
            .format(dateFormat)
        };
        const response = await fetch(url, {
          method: "POST",
          body: JSON.stringify(payload)
        });
        return await response.json();
      };

      changeDate = (pressed, date = null) => {
        pressed === "next"
          ? (date = date.add(1, "d"))
          : (date = date.add(-1, "d"));
        showChart(rooms, date.local());
      };

      nextDay = document.getElementById("nextDay");
      nextDay.addEventListener("click", function() {
        changeDate("next", date);
      });

      prevDay = document.getElementById("prevDay");
      prevDay.addEventListener("click", function() {
        changeDate("prev", date);
      });

      const showChart = async (rooms, date = null) => {
        console.log("Showing chart");

        date = date || moment();

        const open_time = moment.min(
          rooms.map(room => {
            const hours = room.location.hours[date.day()].starthours;
            const time = date
              .clone()
              .hour(Math.floor(hours / 100))
              .minute(hours % 100);
            return time;
          })
        );
        const close_time = moment.max(
          rooms.map(room => {
            const hours = room.location.hours[date.day()].endhours;
            const time = date
              .clone()
              .hour(Math.floor(hours / 100))
              .minute(hours % 100);
            return time;
          })
        );

        const cols = close_time.diff(open_time, "minutes") / 15;
        const rows = rooms.length + 1;

        const stage2 = $("#stage2");

        // render open hours
        stage2.html("");
        stage2.css("grid-template-columns", `auto repeat(${cols}, 1fr)`);
        const openDiv = $("<div/>", {
          class: "open-header",
          text: "Open"
        });

        const openStr = open_time.format("MM/DD hh:mm A");
        const closeStr = close_time.format("MM/DD hh:mm A");
        const openHoursDiv = $("<div/>", {
          class: "open-hours",
          text: `Opening hours: ${openStr} - ${closeStr}`,
          style: "grid-column: 2 / -1"
        });
        stage2.append([openDiv, openHoursDiv]);

        const drawHours = (rowStart = null) => {
          for (let i = 0; i < cols / 4; i++) {
            const time = open_time.clone().add(i, "hours");
            const div = $("<div/>", {
              text: `${time.format("h a")}`,
              style: `grid-column: ${i * 4 + 2} / span 4;`,
              class: "grid-hours"
            });
            if (rowStart !== null) {
              div.css("grid-row", `${rowStart}`);
            }
            stage2.append(div);
          }
        };

        drawHours();

        const open_range = moment.range(open_time, close_time);
        const events = await getRoomsAvailability(rooms, date);

        let cRow = 2; // 1st=header, 2nd=hours, hence the offset
        for (const room of rooms) {
          cRow++;
          const roomNameDiv = $("<div/>", {
            text: room.title,
            style: `grid-row: ${cRow};`,
            class: "room-name"
          });
          stage2.append(roomNameDiv);

          if (events[room.id] && events[room.id].is_closed) {
            const row = $("<div/>", {
              text: `${events[room.id].closed_message}`,
              class: "room-reserved room-closed"
            });
            $(row).css("grid-row", `${cRow}`);
            $(row).css("grid-column", "2 / -1");
            stage2.append(row);
            continue;
          }

          const dates = events[room.id] && events[room.id].dates;
          if (!dates) {
            continue;
          }

          for (const evtId in dates) {
            let { start, end } = dates[evtId];
            start = moment.utc(start).local();
            end = moment.utc(end).local();

            // skip whatever isn't in the current day schedule
            const range = moment.range(start, end);
            if (!range.overlaps(open_range)) {
              continue;
            }

            // truncate to open hours
            start = open_range.contains(start) ? start : open_range.start;
            end = open_range.contains(end) ? end : open_range.end;

            // render
            const colstart =
              2 + Math.floor(start.diff(open_time, "minutes") / 15);
            const colspan = Math.ceil(end.diff(start, "minutes") / 15);
            const day = start.local().format("MMM DD");
            const startTime = start.local().format("hh:mm a");
            const endTime = end.local().format("hh:mm a");
            const hrs = moment.duration(end.diff(start)).humanize(false);
            const row = $("<div/>", {
              text: "",
              class: "reserved-event",
              title: `Reserved on ${day} from ${startTime} to ${endTime} (${hrs})`
            });
            $(row).css("grid-row", `${cRow}`);
            $(row).css("grid-column", `${colstart} / span ${colspan}`);
            stage2.append(row);
          }
        }

        // draw border
        /*
        const div = $("<div/>", {
          "class": "filter",
        });
        div.css("border", "solid 1px black");
        div.css("z-index", 10);
        div.css("grid-column", "1 / -1");
        div.css("grid-row", "1");
        stage2.append(div);
        */

        drawHours(cRow + 1);
      };

      function showLocation() {
        console.log("Showing locations");
        rooms = Array.prototype.map.call(
          document.querySelectorAll(".room-input:checked"),
          el => {
            return findRoom(el.dataset.room);
          }
        );
        saveSelectedRooms(rooms);
        console.log(rooms);

        document.getElementById("stage1").classList.add("hidden");
        document.getElementById("datePicker").classList.remove("hidden");
        const stage2 = document.getElementById("stage2");
        stage2.innerHTML = "Loading...";

        /*
        setInterval(() => {
          showChart(rooms).then(() => {
            console.log("Chart updated");
          });
        }, 1000 * 60 * 5);
        */
        showChart(rooms, date).then(() => {
          console.log("Chart displayed");
        });
      }
    </script>
  </body>
</html>
